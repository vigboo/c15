
services:
  fw:
    hostname: fw
    build: ./fw
    container_name: fw
    privileged: true
    cap_add: [ "NET_ADMIN" ]
    restart: always
    sysctls:
      net.ipv4.ip_forward: 1    
      net.ipv4.conf.all.src_valid_mark: 1              
    networks:
      uplink_net:
        ipv4_address: ${SUBNET_UPLINK}.254
      users_net:
        ipv4_address: ${SUBNET_USERS}.254
      dmz_net:
        ipv4_address: ${SUBNET_DMZ}.254
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.254
      admin_net:
        ipv4_address: ${SUBNET_ADMIN}.254      
      infosec_net:
        ipv4_address: ${SUBNET_INFOSEC}.254
      dev_net:
        ipv4_address: ${SUBNET_DEV}.254
    volumes:
      - ./fw/nftables.conf:/etc/nftables.conf:rw
    environment:
      SVC_IB_ADMIN_PASSWORD: ${SVC_IB_ADMIN_PASSWORD}
      GATEWAY_IP: ${SUBNET_UPLINK}.1
      SUBNET_UPLINK: ${SUBNET_UPLINK}
      SUBNET_ADMIN: ${SUBNET_ADMIN}
      SUBNET_DMZ: ${SUBNET_DMZ}
      SUBNET_INFOSEC: ${SUBNET_INFOSEC}
      SUBNET_SERVERS: ${SUBNET_SERVERS}
      SUBNET_USERS: ${SUBNET_USERS}
      SUBNET_DEV: ${SUBNET_DEV}
      VPN_SRV_IP: ${VPN_SRV_IP}
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}      

# Servers
  srv_espocrm:
    #image: espocrm/espocrm:latest
    build: ./srv_espocrm
    container_name: srv_espocrm
    hostname: srv_espocrm
    cap_add: [ "NET_ADMIN" ]    
    environment:
      APACHE_LOG_DIR: /var/log/apache2
      ESPOCRM_CONFIG_LOGGER_PATH: data/logs/espo.log
      ESPOCRM_DATABASE_PLATFORM: Mysql
      ESPOCRM_DATABASE_HOST: ${SUBNET_SERVERS}.${SRV_ESPOCRM_DB_IP}
      ESPOCRM_DATABASE_USER: espocrm
      ESPOCRM_DATABASE_PASSWORD=: spocrm
      ESPOCRM_DATABASE_NAME: espocrm
      ESPOCRM_ADMIN_USERNAME: admin
      ESPOCRM_ADMIN_PASSWORD: password
      ESPOCRM_SITE_URL: crm.layer8.ag:80
      ESPOCRM_CONFIG_USE_WEB_SOCKET: false
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}     
      GATEWAY_IP: ${SUBNET_SERVERS}.254       
    volumes:
      - ./espocrm/var/www/html:/var/www/html
      - ./espocrm/log/apache2:/var/log/apache2
    networks:
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.${SRV_ESPOCRM_IP}
    depends_on:
      srv_espocrm_db:
        condition: service_healthy
    restart: always
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_espocrm_db:
    image: mariadb:latest
    container_name: srv_espocrm_db
    environment:
      MYSQL_DATABASE: espocrm
      MYSQL_USER: espocrm
      MYSQL_PASSWORD: espocrm
      MYSQL_ROOT_PASSWORD: root_password
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}      
    volumes:
      - ./espocrm/mysql:/var/lib/mysql
    networks:
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.${SRV_ESPOCRM_DB_IP}
        aliases:
          - espocrm-db
    restart: always
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 20s
      start_period: 10s
      timeout: 10s
      retries: 3    
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  espocrm-daemon:
    image: espocrm/espocrm
    container_name: espocrm-daemon
    volumes:
      - espocrm-storage:/var/www/html
    restart: no
    entrypoint: docker-daemon.sh   
    networks:
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.${SRV_ESPOCRM_DM_IP} 
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_ldap:
    build: ./srv_ldap
    container_name: srv_ldap
    hostname: srv_ldap.layer8.ag
    cap_add: [ "NET_ADMIN" ]    
    environment:
      LDAP_ORGANISATION: Layer8Agency
      LDAP_DOMAIN: layer8.ag
      LDAP_BASE_DN: dc=layer8,dc=ag
      LDAP_PPOLICY_ENABLED: true
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_CONFIG_PASSWORD: admin
      LDAP_READONLY_USER: true
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      GATEWAY_IP: ${SUBNET_SERVERS}.254
    volumes:
      - ./srv_ldap/var/lib/ldap:/var/lib/ldap
      - ./srv_ldap/etc/ldap:/etc/ldap/slapd.d
      - ./wazuh/wazuh_agent.sh:/opt/wazuh_agent.sh
      - ./srv_ldap/wazuh/var/ossec/etc:/var/ossec/etc
      - ./srv_ldap/wazuh/var/ossec/queue:/var/ossec/queue
      - ./srv_ldap/wazuh/etc/filebeat:/etc/filebeat
      - ./srv_ldap/wazuh/var/lib/filebeat:/var/lib/filebeat
    networks:
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.${LDAP_SRV_IP}
    restart: always
    healthcheck:
      test: ["CMD", "bash", "-c", "ldapsearch -x -H ldap://127.0.0.1 -D cn=admin,dc=layer8,dc=ag -w ${LDAP_ADMIN_PASSWORD} -b dc=layer8,dc=ag >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 5
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_ldap_mgmt:
    build: ./srv_ldap_mgmt
    container_name: srv_ldap_mgmt
    cap_add: [ "NET_ADMIN" ]        
    depends_on:
      - srv_ldap
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: ${SUBNET_SERVERS}.${LDAP_SRV_IP}
      PHPLDAPADMIN_HTTPS: false
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}      
      GATEWAY_IP: ${SUBNET_ADMIN}.254      
    ports:
      - "8081:80"
    networks:
      admin_net:
        ipv4_address: ${SUBNET_ADMIN}.199
    restart: always
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_dns:
    hostname: srv_dns
    depends_on: [ fw ]
    build: ./srv_dns
    container_name: srv_dns
    cap_add: [ "NET_ADMIN" ]
    restart: always
    networks:
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.${DNS_SRV_IP}
    volumes:
      - ./srv_dns/Corefile:/etc/coredns/Corefile:ro
      - ./srv_dns/layer8.ag.db:/etc/coredns/layer8.ag.db:ro
    dns: ["1.1.1.1", "8.8.8.8"]
    environment:
      GATEWAY_IP: ${SUBNET_SERVERS}.254
      DNS_SRV_IP: ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_users:
    build: ./bastion
    hostname: srv_users
    container_name: srv_users
    cap_add:
      - NET_ADMIN     
    volumes:
      - ./srv_users/home/users:/home/users/ # Персистентность данных пользователей
      - ./srv_users/wazuh/var/ossec/etc:/var/ossec/etc
      - ./srv_users/wazuh/var/ossec/queue:/var/ossec/queue
      - ./srv_users/wazuh/etc/filebeat:/etc/filebeat
      - ./srv_users/wazuh/var/lib/filebeat:/var/lib/filebeat      
    shm_size: "1gb" # Важно для стабильности браузеров и GUI  
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}
      SG_USERS: SG-SRV-USERS-USERS
      SG_ADMINS: SG-SRV-USERS-ADMINS
      GATEWAY_IP: ${SUBNET_USERS}.254
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}          
    ports:
      - 43389:3389
    networks:
      users_net:
        ipv4_address: ${SUBNET_USERS}.${USERS_SRV_IP}
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_dev:
    build: ./bastion
    hostname: srv_dev
    container_name: srv_dev
    cap_add:
      - NET_ADMIN         
    volumes:
      - ./srv_dev/home/users:/home/users/ # Персистентность данных пользователей
      - ./srv_dev/wazuh/var/ossec/etc:/var/ossec/etc
      - ./srv_dev/wazuh/var/ossec/queue:/var/ossec/queue
      - ./srv_dev/wazuh/etc/filebeat:/etc/filebeat
      - ./srv_dev/wazuh/var/lib/filebeat:/var/lib/filebeat        
    shm_size: "1gb" # Важно для стабильности браузеров и GUI  
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}
      SG_USERS: SG-SRV-DEV-USERS
      SG_ADMINS: SG-SRV-DEV-ADMINS
      GATEWAY_IP: ${SUBNET_DEV}.254
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}           
    networks:
      dev_net:
        ipv4_address: ${SUBNET_DEV}.${DEV_SRV_IP}
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}        

  srv_bastion_mgmt:
    build: ./bastion
    hostname: srv_bastion_mgmt
    container_name: srv_bastion_mgmt
    cap_add:
      - NET_ADMIN         
    volumes:
      - ./srv_bastion_mgmt/home/users:/home/users/ # Персистентность данных пользователей
      - ./srv_bastion_mgmt/wazuh/var/ossec/etc:/var/ossec/etc
      - ./srv_bastion_mgmt/wazuh/var/ossec/queue:/var/ossec/queue
      - ./srv_bastion_mgmt/wazuh/etc/filebeat:/etc/filebeat
      - ./srv_bastion_mgmt/wazuh/var/lib/filebeat:/var/lib/filebeat        
    shm_size: "1gb" # Важно для стабильности браузеров и GUI  
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_USERS: SG-SRV-MGMT-USERS
      SG_ADMINS: SG-SRV-MGMT-ADMINS
      GATEWAY_IP: ${SUBNET_ADMIN}.254
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}
    networks:
      admin_net:
        ipv4_address: ${SUBNET_ADMIN}.${BASTION_IT_IP}
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}        

# Infosec
  srv_bastion_ib:
    build: ./bastion
    hostname: srv_bastion_ib
    container_name: srv_bastion_ib
    cap_add:
      - NET_ADMIN        
    volumes:
      - ./srv_bastion_ib/home/users:/home/users/
      - ./srv_bastion_ib/wazuh/var/ossec/etc:/var/ossec/etc
      - ./srv_bastion_ib/wazuh/var/ossec/queue:/var/ossec/queue
      - ./srv_bastion_ib/wazuh/etc/filebeat:/etc/filebeat
      - ./srv_bastion_ib/wazuh/var/lib/filebeat:/var/lib/filebeat      
    shm_size: "1gb" # Важно для стабильности браузеров и GUI  
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_USERS: SG-SRV-BASTION-IB-USERS
      SG_ADMINS: SG-SRV-BASTION-IB-ADMINS
      GATEWAY_IP: ${SUBNET_INFOSEC}.254   
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}      
    networks:
      infosec_net:
        ipv4_address: ${SUBNET_INFOSEC}.${BASTION_IB_IP}
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}        

  srv_wg_portal:
    build: ./srv_wg_portal
    container_name: srv_wg_portal
    hostname: srv_wg_portal
    restart: always
    cap_add:
      - NET_ADMIN
    volumes:
      - ./srv_wg_portal/data:/app/data
      - ./srv_wg_portal/config:/app/config
      - ./srv_wg_portal/etc/wireguard:/etc/wireguard   # Конфиги интерфейсов    
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    environment:  
      WB_ENABLE_NAT: true
      GATEWAY_IP: ${SUBNET_DMZ}.254
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      WG_PORTAL_ADMIN_USERNAME: ${WG_PORTAL_ADMIN_USERNAME}
      WG_PORTAL_ADMIN_PASSWORD: ${WG_PORTAL_ADMIN_PASSWORD}
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}
    networks:
      dmz_net:
        ipv4_address: ${SUBNET_DMZ}.${VPN_SRV_IP}
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}        

# Wazuh App Copyright (C) 2017, Wazuh Inc. (License GPLv2)
  srv_wazuh_manager:
    build: ./srv_wazuh_manager
    hostname: srv_wazuh_manager
    container_name: srv_wazuh_manager
    restart: always
    cap_add:
      - NET_ADMIN         
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1514:1514"
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      INDEXER_URL: https://wazuh.indexer:9200
      INDEXER_USERNAME: admin
      INDEXER_PASSWORD: SecretPassword
      FILEBEAT_SSL_VERIFICATION_MODE: full
      SSL_CERTIFICATE_AUTHORITIES: /etc/ssl/root-ca.pem
      SSL_CERTIFICATE: /etc/ssl/filebeat.pem
      SSL_KEY: /etc/ssl/filebeat.key
      API_USERNAME: wazuh-wui
      API_PASSWORD: MyS3cr37P450r.*-
      GATEWAY_IP: ${SUBNET_INFOSEC}.254 
    volumes:
      - ./srv_wazuh_manager/var/ossec/api/configuration:/var/ossec/api/configuration
      - ./srv_wazuh_manager/var/ossec/etc:/var/ossec/etc
      - ./srv_wazuh_manager/var/ossec/logs:/var/ossec/logs
      - ./srv_wazuh_manager/ossec/queue:/var/ossec/queue
      - ./srv_wazuh_manager/var/ossec/var/multigroups:/var/ossec/var/multigroups
      - ./srv_wazuh_manager/var/ossec/integrations:/var/ossec/integrations
      - ./srv_wazuh_manager/var/ossec/active-response/bin:/var/ossec/active-response/bin
      - ./srv_wazuh_manager/var/ossec/agentless:/var/ossec/agentless
      - ./srv_wazuh_manager/var/ossec/wodles:/var/ossec/wodles
      - ./srv_wazuh_manager/etc/filebeat:/etc/filebeat
      - ./srv_wazuh_manager/var/lib/filebeat:/var/lib/filebeat
      - ./wazuh/config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/wazuh.manager.pem:/etc/ssl/filebeat.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/wazuh.manager-key.pem:/etc/ssl/filebeat.key
      - ./wazuh/config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
    networks:
      infosec_net:
        ipv4_address: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
        aliases:
          - wazuh.manager
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}             

  srv_wazuh_indexer:
    build: ./srv_wazuh_indexer
    hostname: srv_wazuh_indexer
    container_name: srv_wazuh_indexer
    restart: always
    cap_add:
      - NET_ADMIN
    ports:
      - "9200:9200"
    environment:
      OPENSEARCH_JAVA_OPTS: -Xms1g -Xmx1g
      GATEWAY_IP: ${SUBNET_INFOSEC}.254
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ./srv_wazuh_indexer/var/lib/wazuh-indexer:/var/lib/wazuh-indexer
      - ./wazuh/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/config/certs/root-ca.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/wazuh.indexer-key.pem:/usr/share/wazuh-indexer/config/certs/wazuh.indexer.key
      - ./wazuh/config/wazuh_indexer_ssl_certs/wazuh.indexer.pem:/usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/config/certs/admin.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/config/certs/admin-key.pem
      - ./wazuh/config/wazuh_indexer/wazuh.indexer.yml:/usr/share/wazuh-indexer/config/opensearch.yml
      - ./wazuh/config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml
    networks:
      infosec_net:
        ipv4_address: ${SUBNET_INFOSEC}.89
        aliases:
          - wazuh.indexer        
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}          

  srv_wazuh_dashboard:
    build: ./srv_wazuh_dashboard
    hostname: srv_wazuh_dashboard
    container_name: srv_wazuh_dashboard
    restart: always
    cap_add:
      - NET_ADMIN         
    ports:
      - 443:5601
    environment:
      INDEXER_USERNAME: admin
      INDEXER_PASSWORD: SecretPassword
      WAZUH_API_URL: https://${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      DASHBOARD_USERNAME: kibanaserver
      DASHBOARD_PASSWORD: kibanaserver
      API_USERNAME: wazuh-wui
      API_PASSWORD: MyS3cr37P450r.*-
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}      
      GATEWAY_IP: ${SUBNET_INFOSEC}.254
    volumes:
      - ./wazuh/config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
      - ./wazuh/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem
      - ./wazuh/config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - ./wazuh/config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
      - ./srv_wazuh_dashboard/config:/usr/share/wazuh-dashboard/data/wazuh/config
      - ./srv_wazuh_dashboard/custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
      - ./fw/iproute.sh:/opt/iproute.sh
    depends_on:
      - srv_wazuh_indexer
    networks:
      infosec_net:
        ipv4_address: ${SUBNET_INFOSEC}.90
        aliases:
          - wazuh.manager
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}   

  srv_leafwiki:
    #image: ghcr.io/perber/leafwiki:latest
    build: ./srv_leafwiki
    container_name: srv_leafwiki
    hostname: srv_leafwiki
    cap_add:
      - NET_ADMIN      
    restart: no
    environment:
      LEAFWIKI_HOST: 0.0.0.0
      LEAFWIKI_PORT: 80
      LEAFWIKI_JWT_SECRET: ${LEAFWIKI_JWT_SECRET}
      LEAFWIKI_ADMIN_PASSWORD: ${LEAFWIKI_ADMIN_PASSWORD}
      GATEWAY_IP: ${SUBNET_SERVERS}.254
    volumes:
      - ./srv_leafwiki/data:/app/data
    networks:
      servers_net:
        ipv4_address: ${SUBNET_SERVERS}.${LEAFWIKI_SRV_IP}
    ports:
      - "8088:80"
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_web:
    hostname: srv_web
    depends_on: [ fw ]
    build: ./srv_web
    container_name: srv_web
    cap_add: [ "NET_ADMIN" ]
    restart: always
    networks:
      dmz_net:
        ipv4_address: ${SUBNET_DMZ}.${WEB_SRV_IP}
    ports:
      - "8089:80"    
    volumes:
      - ./www:/usr/share/nginx/html:ro
      - ./srv_web/zz-server.conf:/etc/nginx/http.d/zz-server.conf:rw
      - ./srv_web/nginx.conf:/etc/nginx/nginx.conf:rw
    # Настройка маршрута, пользователей, SSH и nginx
    environment:
      GATEWAY_IP: ${SUBNET_DMZ}.254
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_ADMINS: SG-SRV-WEB-ADMINS
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}         
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  srv_waf:
    build: ./srv_waf
    #image: owasp/modsecurity-crs:nginx
    hostname: srv_waf
    container_name: srv_waf
    cap_add: [ "NET_ADMIN" ]    
    depends_on: [ fw ]    
    ports:
      - "8082:8082"
    networks:
      dmz_net:
        ipv4_address: ${SUBNET_DMZ}.${WAF_SRV_IP}     
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_ADMINS: SG-SRV-WAF-ADMINS
      GATEWAY_IP: ${SUBNET_DMZ}.254   
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}
      #############################################
      SERVERNAME: ${SUBNET_DMZ}.75 
      #############################################
      # CRS Variables
      #############################################
      # Paranoia Level
      PARANOIA: 1
      BACKEND: http://${SUBNET_DMZ}.${WEB_SRV_IP}:80
      # Replaces PARANOIA as of CRS 4
      BLOCKING_PARANOIA: 1
      # Inbound and Outbound Anomaly Score Threshold
      ANOMALY_INBOUND: 5
      ANOMALY_OUTBOUND: 4
      PORT: 8082
      # Executing Paranoia Level
      # - EXECUTING_PARANOIA=2
      #
      # Replaces EXECUTING_PARANOIA as of CRS 4
      # - DETECTION_PARANOIA=2
      #
      # New in CRS 4
      REPORTING_LEVEL: 2

      #######################################################
      # Various CRS Variables with Default Values
      #######################################################
      # ENFORCE_BODYPROC_URLENCODED: 1
      # ALLOWED_METHODS: GET HEAD POST OPTIONS
      # ALLOWED_REQUEST_CONTENT_TYPE: '|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'
      # ALLOWED_REQUEST_CONTENT_TYPE_CHARSET: 'utf-8|iso-8859-1|iso-8859-15|windows-1252'
      # ALLOWED_HTTP_VERSIONS: HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0
      # RESTRICTED_EXTENSIONS: .asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/
      # RESTRICTED_HEADERS_BASIC: /content-encoding/ /proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/
      # RESTRICTED_HEADERS_EXTENDED: /accept-charset/
      # STATIC_EXTENSIONS: /.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/

      #######################################################
      # CRS Variables with Default Value unlimited
      #######################################################
      # MAX_NUM_ARGS: 255
      # ARG_NAME_LENGTH: 100
      # ARG_LENGTH: 400
      # TOTAL_ARG_LENGTH: 64000
      # MAX_FILE_SIZE: 1048576
      # COMBINED_FILE_SIZES: 1048576

      # OTHERS
      ACCESSLOG: /var/log/nginx/access.log
      ERRORLOG: /var/log/modsec_error.log      
      MODSEC_AUDIT_LOG: /var/log/modsec_audit.log      
      MODSEC_AUDIT_ENGINE: on
      LOGLEVEL: warn
      SERVER_ADMIN: admin@layer8.ag
      #SERVER_NAME: layer8.ag
      MODSEC_RULE_ENGINE: on
      MODSEC_REQ_BODY_ACCESS: on
      MODSEC_REQ_BODY_LIMIT: 13107200
      MODSEC_REQ_BODY_NOFILES_LIMIT: 131072
      MODSEC_RESP_BODY_ACCESS: on
      MODSEC_RESP_BODY_LIMIT: 524288
      MODSEC_PCRE_MATCH_LIMIT: 1000
      MODSEC_PCRE_MATCH_LIMIT_RECURSION: 1000
      VALIDATE_UTF8_ENCODING: 1
      CRS_ENABLE_TEST_MARKER: 1
    volumes:
      - ./srv_waf/log/access.log:/var/log/nginx/access.log:rw
      - ./srv_waf/log/modsec_error.log:/var/log/modsec_error.log:rw
      - ./srv_waf/log/modsec_audit.log:/var/log/modsec_audit.log:rw
      - ./wazuh/wazuh_agent.sh:/opt/wazuh_agent.sh
      - ./srv_waf/wazuh/var/ossec/etc:/var/ossec/etc
      - ./srv_waf/wazuh/var/ossec/queue:/var/ossec/queue
      - ./srv_waf/wazuh/etc/filebeat:/etc/filebeat
      - ./srv_waf/wazuh/var/lib/filebeat:/var/lib/filebeat      

  pc_student:
    build: ./pc
    hostname: pc_student
    container_name: pc_student
    depends_on:
      - srv_wg_portal
      - fw
      - srv_dns
    cap_add:
      - NET_ADMIN        
    volumes:
      - ./pc_student/home/:/home/student
      - ./pc_student/wg0.conf:/etc/wireguard/wg0.conf
    shm_size: "1gb" # Важно для стабильности браузеров и GUI dd 
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_ADMINS: SG-SRV-PC-ADMINS
      GATEWAY_IP: ${SUBNET_UPLINK}.1
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}       
      PC_USERNAME: $PC_USERNAME_STUDENT
      PC_USERPWD: $PC_USERPWD_STUDENT
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}      
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}
    ports:
      - "33389:3389"
    networks:
      uplink_net:
        ipv4_address: ${SUBNET_UPLINK}.221

  pc_vpupkin:
    build: ./pc
    hostname: pc_vpupkin
    container_name: pc_vpupkin 
    depends_on:
      - srv_wg_portal
      - fw
      - srv_dns    
    cap_add:
      - NET_ADMIN        
    volumes:
      - ./pc_vpupkin/home/:/home/vpupkin
      - ./pc_vpupkin/wg0.conf:/etc/wireguard/wg0.conf
    shm_size: "1gb" # Важно для стабильности браузеров и GUI dd 
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_ADMINS: SG-SRV-PC-ADMINS
      GATEWAY_IP: ${SUBNET_UPLINK}.1
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}       
      PC_USERNAME: $PC_USERNAME_VPUPKIN
      PC_USERPWD: $PC_USERPWD_VPUPKIN
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}      
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}
    ports:
      - "53389:3389"
    networks:
      uplink_net:
        ipv4_address: ${SUBNET_UPLINK}.143

  pc_vkrutikov:
    build: ./pc
    hostname: pc_vkrutikov
    container_name: pc_vkrutikov
    depends_on:
      - srv_wg_portal
      - fw
      - srv_dns    
    cap_add:
      - NET_ADMIN        
    volumes:
      - ./pc_vkrutikov/scenario.sh:/opt/scenario.sh
      - ./pc_vkrutikov/wg0.conf:/etc/wireguard/wg0.conf      
    environment:
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER_USERNAME}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD}  
      SG_ADMINS: SG-SRV-PC-ADMINS
      GATEWAY_IP: ${SUBNET_UPLINK}.1
      PC_USERNAME: $PC_USERNAME_STUDENT
      PC_USERPWD: $PC_USERPWD_STUDENT
      LDAP_SUFFIX: $LDAP_SUFFIX      
      WAZUH_MANAGER_IP: ${SUBNET_INFOSEC}.${WAZUH_SRV_IP}  
      LDAP_SRV_IP: ${SUBNET_SERVERS}.${LDAP_SRV_IP}    
      SCENARIO_PERIOD: 1
    networks:
      uplink_net:
        ipv4_address: ${SUBNET_UPLINK}.201   
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}        

  pc_inet:
    cap_add:
      - NET_ADMIN     
    build: ./pc_inet
    hostname: pc_inet
    container_name: pc_inet
    volumes:
      - ./pc_inet/payload.txt:/opt/payload.txt
      - ./pc_inet/sqli.py:/opt/script.py
    environment:
      GATEWAY_IP: ${SUBNET_UPLINK}.254
    networks:
      uplink_net:
        ipv4_address: ${SUBNET_UPLINK}.178
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

  pc_inet2:
    cap_add:
      - NET_ADMIN     
    build: ./pc_inet
    hostname: pc_inet2
    container_name: pc_inet2
    volumes:
      - ./pc_inet2/dos.py:/opt/script.py
    environment:
      GATEWAY_IP: ${SUBNET_UPLINK}.254
    networks:
      uplink_net:
        ipv4_address: ${SUBNET_UPLINK}.112
    dns:
      - ${SUBNET_SERVERS}.${DNS_SRV_IP}

networks:
  uplink_net:
    name: uplink_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_UPLINK}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-uplink
      com.docker.network.bridge.enable_ip_masquerade: "false"      
  dev_net:
    name: dev_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_DEV}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-dev
      com.docker.network.bridge.enable_ip_masquerade: "false"            
  users_net:
    name: users_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_USERS}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-users
      com.docker.network.bridge.enable_ip_masquerade: "false"            
  dmz_net:
    name: dmz_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_DMZ}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-dmz
      com.docker.network.bridge.enable_ip_masquerade: "false"            
  servers_net:
    name: servers_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_SERVERS}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-servers
      com.docker.network.bridge.enable_ip_masquerade: "false"            
  admin_net:
    name: admin_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_ADMIN}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-admin
      com.docker.network.bridge.enable_ip_masquerade: "false"            
  infosec_net:
    name: infosec_net
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET_INFOSEC}.0/24
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.name: br-infosec
      com.docker.network.bridge.enable_ip_masquerade: "false"            

volumes:
  espocrm-storage:
